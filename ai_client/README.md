# Godot AI æ¸¸æˆå®¢æˆ·ç«¯ - HTTP REST API ç½‘å…³

å¤–éƒ¨ AI æ§åˆ¶ Godot æ¸¸æˆçš„ HTTP REST API æ–¹æ¡ˆã€‚æ”¯æŒåŠ¨æ€ç«¯å£ã€Headless/GUI åŒæ¨¡å¼ã€å´©æºƒæ£€æµ‹ã€‚

## åŠŸèƒ½ç‰¹æ€§

- **HTTP REST API**: é€šè¿‡ HTTP æ¥æ”¶åŠ¨ä½œè¯·æ±‚ï¼Œè¿”å›æ¸¸æˆçŠ¶æ€
- **åŠ¨æ€ç«¯å£åˆ†é…**: è‡ªåŠ¨å¯»æ‰¾å¯ç”¨ç«¯å£ï¼Œé¿å…å†²çª
- **åŒæ¨¡å¼å¯åŠ¨**: æ”¯æŒ Headlessï¼ˆæ— å¤´ï¼‰å’Œ GUIï¼ˆå›¾å½¢ç•Œé¢ï¼‰æ¨¡å¼
- **å´©æºƒæ£€æµ‹**: å®æ—¶ç›‘æ§ Godot è¾“å‡ºï¼Œæ•è· SCRIPT ERROR ç­‰å´©æºƒ
- **è¿›ç¨‹ç®¡ç†**: è‡ªåŠ¨å¯åŠ¨ã€ç›‘æ§å’Œæ¸…ç† Godot è¿›ç¨‹

## ç›®å½•ç»“æ„

```
ai_client/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶
â”œâ”€â”€ API_DOCUMENTATION.md         # å®Œæ•´ API å‚è€ƒ
â”œâ”€â”€ ai_game_client.py            # ä¸»ç¨‹åºï¼ˆHTTP ç½‘å…³ï¼‰
â”œâ”€â”€ godot_process.py             # Godot è¿›ç¨‹ç®¡ç†å™¨
â”œâ”€â”€ http_server.py               # HTTP REST æœåŠ¡å™¨
â””â”€â”€ utils.py                     # å·¥å…·å‡½æ•°
```

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼1ï¼šHeadless æ¨¡å¼ï¼ˆæ¨èç”¨äºè®­ç»ƒï¼‰

```bash
cd /home/zhangzhan/tower
python3 ai_client/ai_game_client.py
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
============================================================
Godot AI å®¢æˆ·ç«¯å·²å¯åŠ¨ - Headless æ¨¡å¼
============================================================
HTTP ç«¯å£: 10000
Godot WebSocket ç«¯å£: 10001

ä½¿ç”¨ç¤ºä¾‹:
  curl -X POST http://127.0.0.1:10000/action \
       -H "Content-Type: application/json" \
       -d '{"actions": [{"type": "start_wave"}]}'

æŒ‰ Ctrl+C åœæ­¢
============================================================
```

### æ–¹å¼2ï¼šGUI æ¨¡å¼ï¼ˆç”¨äºè°ƒè¯•è§‚å¯Ÿï¼‰

```bash
python3 ai_client/ai_game_client.py --visual
```

### ä½¿ç”¨ curl å‘é€è¯·æ±‚

```bash
# è·å–çŠ¶æ€
curl http://127.0.0.1:<port>/status

# å‘é€åŠ¨ä½œ
curl -X POST http://127.0.0.1:<port>/action \
  -H "Content-Type: application/json" \
  -d '{"actions": [{"type": "select_totem", "totem_id": "wolf_totem"}]}'
```

## HTTP API

### POST /action

å‘é€æ¸¸æˆåŠ¨ä½œï¼Œè¿”å›æ¸¸æˆçŠ¶æ€ã€‚

**è¯·æ±‚ä½“ï¼š**
```json
{
  "actions": [
    {"type": "buy_unit", "shop_index": 0},
    {"type": "start_wave"}
  ]
}
```

**æ­£å¸¸å“åº”ï¼š**
```json
{
  "event": "WaveStarted",
  "event_data": {"wave": 1},
  "timestamp": 1234567890,
  "global": {...},
  "board": {...}
}
```

**å´©æºƒå“åº”ï¼š**
```json
{
  "event": "SystemCrash",
  "error_type": "SCRIPT ERROR: ...",
  "stack_trace": "..."
}
```

### GET /status

è·å–æœåŠ¡å™¨å’Œ Godot è¿›ç¨‹çŠ¶æ€ã€‚

**å“åº”ï¼š**
```json
{
  "godot_running": true,
  "ws_connected": true,
  "http_port": 12345,
  "godot_ws_port": 45678,
  "visual_mode": false,
  "crashed": false
}
```

### GET /health

å¥åº·æ£€æŸ¥ã€‚

**å“åº”ï¼š**
```json
{"status": "ok"}
```

## å‘½ä»¤è¡Œå‚æ•°

```
python3 ai_game_client.py [é€‰é¡¹]

é€‰é¡¹:
  --visual, --gui       å¯ç”¨ GUI æ¨¡å¼ï¼ˆæ˜¾ç¤ºæ¸¸æˆçª—å£ï¼‰
  --project PATH, -p PATH
                        Godot é¡¹ç›®è·¯å¾„ (é»˜è®¤: /home/zhangzhan/tower)
  --scene PATH, -s PATH
                        å¯åŠ¨åœºæ™¯è·¯å¾„ (é»˜è®¤: res://src/Scenes/UI/CoreSelection.tscn)
  --http-port PORT      HTTP æœåŠ¡å™¨ç«¯å£ (0=è‡ªåŠ¨åˆ†é…)
  --godot-port PORT     Godot WebSocket ç«¯å£ (0=è‡ªåŠ¨åˆ†é…)
```

## æ ¸å¿ƒåŠ¨ä½œ

| åŠ¨ä½œ | ç¤ºä¾‹ |
|------|------|
| é€‰æ‹©å›¾è…¾ | `{"type": "select_totem", "totem_id": "wolf_totem"}` |
| è´­ä¹°å•ä½ | `{"type": "buy_unit", "shop_index": 0}` |
| ç§»åŠ¨å•ä½ | `{"type": "move_unit", "from_zone": "bench", "from_pos": 0, "to_zone": "grid", "to_pos": {"x": 0, "y": 0}}` |
| å‡ºå”®å•ä½ | `{"type": "sell_unit", "zone": "bench", "pos": 0}` |
| åˆ·æ–°å•†åº— | `{"type": "refresh_shop"}` |
| å¼€å§‹æ³¢æ¬¡ | `{"type": "start_wave"}` |
| æ¢å¤æ¸¸æˆ | `{"type": "resume", "wait_time": 0.5}` |

### ä½œå¼ŠæŒ‡ä»¤ï¼ˆæµ‹è¯•ç”¨ï¼‰

| åŠ¨ä½œ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|
| æ·»åŠ é‡‘å¸ | `{"type": "cheat_add_gold", "amount": 100}` | æ·»åŠ æŒ‡å®šæ•°é‡é‡‘å¸ |
| æ·»åŠ æ³•åŠ› | `{"type": "cheat_add_mana", "amount": 100}` | æ·»åŠ æŒ‡å®šæ•°é‡æ³•åŠ› |
| ç”Ÿæˆå•ä½ | `{"type": "cheat_spawn_unit", "unit_type": "wolf", "level": 1, "zone": "bench", "pos": 0}` | åœ¨æŒ‡å®šä½ç½®ç”Ÿæˆå•ä½ |
| è®¾ç½®å•†åº—å•ä½ | `{"type": "cheat_set_shop_unit", "shop_index": 0, "unit_key": "wolf"}` | è®¾ç½®å•†åº—æŒ‡å®šæ§½ä½ä¸ºå•ä½ |
| è®¾ç½®æ—¶é—´æµé€Ÿ | `{"type": "cheat_set_time_scale", "scale": 2.0}` | è®¾ç½®æ¸¸æˆæ—¶é—´æµé€Ÿï¼ˆ0.1-10.0ï¼‰ |

### æŠ€èƒ½æŒ‡ä»¤

| åŠ¨ä½œ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|
| ä½¿ç”¨æŠ€èƒ½ | `{"type": "use_skill", "grid_pos": {"x": 0, "y": 1}}` | è§¦å‘æŒ‡å®šä½ç½®å•ä½çš„ä¸»åŠ¨æŠ€èƒ½ |
| è·å–å•ä½ä¿¡æ¯ | `{"type": "get_unit_info", "grid_pos": {"x": 0, "y": 1}}` | è·å–å•ä½çš„è¯¦ç»†å±æ€§ã€æŠ€èƒ½å’Œ buff ä¿¡æ¯ |

**å•ä½ä¿¡æ¯è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "event": "ActionsCompleted",
  "unit_info": {
    "type_key": "tiger",
    "level": 2,
    "hp": 150,
    "max_hp": 200,
    "damage": 45,
    "atk_speed": 1.2,
    "range": 120,
    "crit_rate": 0.15,
    "skill": {
      "name": "roar",
      "cooldown": 0,
      "max_cooldown": 15.0,
      "mana_cost": 50,
      "ready": true
    },
    "buffs": ["range", "speed"],
    "temporary_buffs": [{"stat": "damage", "amount": 10, "duration": 5.0}]
  }
}
```

### å¯ç”¨å›¾è…¾

| å›¾è…¾ | ç±»å‹ |
|------|------|
| `wolf_totem` | ç‹¼å›¾è…¾ï¼ˆè¿›æ”»å‹ï¼‰ |
| `cow_totem` | ç‰›å›¾è…¾ï¼ˆé˜²å¾¡å‹ï¼‰ |
| `bat_totem` | è™è å›¾è…¾ï¼ˆæ•æ·å‹ï¼‰ |
| `viper_totem` | æ¯’è›‡å›¾è…¾ï¼ˆæ¯’ç´ å‹ï¼‰ |
| `butterfly_totem` | è´è¶å›¾è…¾ï¼ˆè¾…åŠ©å‹ï¼‰ |
| `eagle_totem` | é¹°å›¾è…¾ï¼ˆè¿œç¨‹å‹ï¼‰ |

## æ¸¸æˆäº‹ä»¶

| äº‹ä»¶ | è¯´æ˜ |
|------|------|
| `TotemSelection` | å›¾è…¾é€‰æ‹©é˜¶æ®µï¼ˆæ¸¸æˆå¼€å§‹ï¼‰ |
| `TotemSelected` | å›¾è…¾å·²é€‰æ‹©ï¼ˆå¯å¼€å§‹ç¬¬ä¸€æ³¢ï¼‰ |
| `WaveEnded` | æ³¢æ¬¡ç»“æŸï¼ˆè´­ä¹°é˜¶æ®µï¼‰ |
| `WaveStarted` | æ³¢æ¬¡å¼€å§‹ |
| `BossSpawned` | Boss ç”Ÿæˆ |
| `CoreDamaged` | æ ¸å¿ƒå—åˆ°æ”»å‡»ï¼ˆè¡€é‡ >= 30%ï¼‰ |
| `CoreCritical` | æ ¸å¿ƒè¡€é‡ä½äº 30% |
| `TrapPlaced` | æ¯’é™·é˜±å·²æ”¾ç½® |
| `TrapTriggered` | æ¯’é™·é˜±è¢«è§¦å‘ |
| `AI_Wakeup` | resume å»¶æ—¶åˆ°æœŸ |
| `GameOver` | æ¸¸æˆç»“æŸ |
| `SystemCrash` | Godot å´©æºƒï¼ˆPython ç«¯æ£€æµ‹ï¼‰ |

## æ•Œäººä¿¡æ¯

ä»…åœ¨ `is_wave_active` ä¸º true æ—¶ï¼ŒçŠ¶æ€æ¶ˆæ¯ä¼šåŒ…å« `enemies` æ•°ç»„ã€‚

**è®¾è®¡ç†å¿µï¼š** åªä¼ é€’æ•Œäººçš„**åå­—**å’Œ**åŠ¨æ€ä¿¡æ¯**ï¼ŒAI å¯é€šè¿‡æŸ¥è¡¨è·å–æ•Œäººçš„é™æ€å±æ€§ã€‚

```json
{
  "enemies": [
    {
      "name": "slime",
      "hp": 80.0,
      "position": {"x": 120.5, "y": 200.0},
      "state": "move",
      "split_generation": 0,
      "debuffs": [
        {"type": "poison", "stacks": 3},
        {"type": "bleed", "stacks": 5}
      ]
    }
  ]
}
```

**ä¼ é€’çš„å­—æ®µï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `name` | string | **æ•Œäººåå­—**ï¼Œç”¨äºæŸ¥è¡¨è·å–å®Œæ•´å±æ€§ |
| `hp` | float | å½“å‰è¡€é‡ï¼ˆåŠ¨æ€ï¼‰ |
| `position` | object | ä½ç½®åæ ‡ {"x": float, "y": float}ï¼ˆåŠ¨æ€ï¼‰ |
| `state` | string | çŠ¶æ€ï¼šmove, attack_base, stunned, supportï¼ˆåŠ¨æ€ï¼‰ |
| `is_charmed` | bool | æ˜¯å¦è¢«é­…æƒ‘ï¼ˆåŠ¨æ€ï¼‰ |
| `split_generation` | int | å²è±å§†åˆ†è£‚ä»£æ•°ï¼ˆåŠ¨æ€ï¼‰ |
| `debuffs` | array | Debuff åˆ—è¡¨ï¼ŒåŒ…å« type å’Œ stacksï¼ˆåŠ¨æ€ï¼‰ |

**debuff ç±»å‹ï¼š**
- `poison` - ä¸­æ¯’
- `burn` - ç‡ƒçƒ§
- `bleed` - æµè¡€
- `slow` - å‡é€Ÿ
- `stun` - çœ©æ™•
- `freeze` - å†»ç»“
- `blind` - å¤±æ˜
- `vulnerable` - æ˜“ä¼¤

**AI æŸ¥è¡¨è·å–çš„é™æ€å±æ€§ï¼š**

é€šè¿‡ `name` å­—æ®µæŸ¥è¯¢ `data/game_data.json` ä¸­çš„ `ENEMY_TYPES`ï¼Œå¯è·å–ï¼š
- `max_hp` - æœ€å¤§è¡€é‡
- `damage` - æ”»å‡»åŠ›
- `speed` - ç§»åŠ¨é€Ÿåº¦
- `attack_speed` - æ”»å‡»é€Ÿåº¦
- `attack_type` - æ”»å‡»ç±»å‹ï¼ˆmelee/rangedï¼‰
- `range` - è¿œç¨‹å°„ç¨‹
- `is_boss` - æ˜¯å¦ä¸º Boss
- `is_suicide` - æ˜¯å¦è‡ªçˆ†
- `radius` - ç¢°æ’åŠå¾„
- ç­‰ç­‰...

## æµ‹è¯•

### å´©æºƒæ£€æµ‹æµ‹è¯•

```bash
# ä½¿ç”¨ TestCrash åœºæ™¯ï¼ˆä¸»åŠ¨è§¦å‘ GDScript é”™è¯¯ï¼‰
python3 ai_client/ai_game_client.py --scene res://src/Scenes/Test/TestCrash.tscn --visual
```

é¢„æœŸè¾“å‡ºåŒ…å« `SystemCrash` äº‹ä»¶ã€‚

### å®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
python3 tests/test_crash_detection.py
```

## æ–‡æ¡£å¯¼èˆª

| éœ€æ±‚ | é˜…è¯»æ–‡æ¡£ |
|------|----------|
| å®Œæ•´åè®®å‚è€ƒ | [API_DOCUMENTATION.md](API_DOCUMENTATION.md) |

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ai_game_client.py                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  HTTP Server â”‚â—„â”€â”€â”€â”‚  è¯·æ±‚è·¯ç”±    â”‚â—„â”€â”€â”€â”‚ å¤–éƒ¨ curl    â”‚  â”‚
â”‚  â”‚  (éšæœºç«¯å£)  â”‚    â”‚  /action     â”‚    â”‚ è°ƒç”¨         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                               â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚ WebSocketâ”‚ â† å†…éƒ¨è½¬å‘              â”‚
â”‚                        â”‚ Client   â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â”‚
â”‚                             â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    Godot å­è¿›ç¨‹          â”‚                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚   AIManager.gd        â–¼                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚WebSocket Srv â”‚  â”‚ --ai-port    â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ (åŠ¨æ€ç«¯å£)   â”‚  â”‚ å‚æ•°è§£æ     â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚           â–²                                        â”‚   â”‚
â”‚  â”‚           â”‚ stdout/stderr æµç›‘æ§                   â”‚   â”‚
â”‚  â”‚           â”‚ (SCRIPT ERROR æ£€æµ‹)                    â”‚   â”‚
â”‚  â”‚           â–¼                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  å´©æºƒå¤„ç†å™¨: kill() + è¿”å› SystemCrash JSON â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è°ƒè¯•æŠ€å·§

Godot æœåŠ¡ç«¯è¾“å‡ºå½©è‰²ä¸­æ–‡æ—¥å¿—ï¼š
- ğŸ”µ è“è‰²ï¼šç½‘ç»œæ—¥å¿—
- ğŸŸ¢ ç»¿è‰²ï¼šäº‹ä»¶æ—¥å¿—
- ğŸŸ  æ©™è‰²ï¼šåŠ¨ä½œæ—¥å¿—
- ğŸ”´ çº¢è‰²ï¼šé”™è¯¯æ—¥å¿—
